{% extends 'base.html' %}
{% load static %}
{% block title %} Sale report {% endblock %}
{% block content%}
    <content>
        <div class="top-header">
            <div class="row">
                <div class="col-sm-12 col-lg-12 col-xs-12 text-left wow fadeInUp" data-wow-duration="0.9s" data-wow-delay="0.1s">
                    <h5 class="title_style">UPLOAD SALES REPORT/ BILLING DETAILS</h5>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="#">Report management</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Upload sales/billing reports</li>
                    </ol>
                </div>
            </div>
        </div>
        <div class="content-wrapper baner_sm">
            <div class="row">
                <div class="col-12">
                    <div class="row">
                        <div class="col-sm-12 align_center">
                            {% if form.file.errors.0 == 'It seems like there is no airline with this 3 digit code.' %}
                            <a  href="{% url 'add_airline' %}?next={% url 'upload_report' %}" class="primary_btn">create a new airline</a>
                            {% endif %}
                            {% if miss_match_errors %}
                            <b>
                                Value mismatch found{{miss_match_errors}}:<br>
                                {% if miss_match_errors.transaction_file_total and miss_match_errors.trans_total %}
                                Total transaction from file : {{miss_match_errors.transaction_file_total}} and Total transaction generated: {{miss_match_errors.trans_total}}<br>
                                {% endif %}
                                {% if miss_match_errors.fare_file and miss_match_errors.fare_transaction %}
                                Fare amount from file: {{miss_match_errors.fare_file}} and fare amount autogenerated : {{miss_match_errors.fare_transaction}}<br>
                                {% endif %}
                                Please check the file once again before uploading it again.
                            </b>
                            {% endif %}
                        </div>
                        <div class="col-12">

                            <form action="." method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-element form-input upload_field wow fadeIn" data-wow-duration="0.9s" data-wow-delay="0.2s">
                                                <span class="file_name_placeholder">File name</span>

                                            <input class="form-control file_upload_input" onclick="fileClicked(event)" onchange="fileChanged(event)" type="file" name="file" id="id_file" required="" value= "{{ form.file.value|default_if_none:"" }}">
                                            <!--<small class="form-element-hint">{{ form.file.errors }}</small>-->
                                        </div>
                                    </div>
                                </div>
                                <div class="align_right button_group w_500 ma wow fadeIn" data-wow-duration="0.9s" data-wow-delay="0.5s">
                                    <a href="{% url 'upload_report' %}" id="cancelLink">Cancel</a>
                                    <input type="submit" class="primary_btn" value="Submit">
                                    <span class="info_btn">
                                        <div class="info_content" style="z-index:100">
                                            {% if is_arc %}
                                                If you are planning to upload a bunch of files together, please make sure that you have created separate <b>zip</b> files for carrier report other wise system will display error message. Carrier deduction and disbursement advice can be uploaded together in one zip file. Please make sure that carrier report has been uploaded before uploading the other 2 file.
                                            {% else %}
                                                If you are planning to upload a bunch of files together, please make sure that you have created separate <b>zip </b>files for both billing details and daily transaction files, other wise system will display error message
                                            {% endif %}
                                        </div>
                                    </span>
                                </div>

                            </form>
                        </div>
                        {% if errMsg %}
                            <div class="alert alert-danger" style="margin-top: 1em; width: 100%">
                                <a class="close" href="#" data-dismiss="alert">Ã—</a>
                                {{ errMsg }}
                            </div>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
    </content>
{% endblock %}

{% block app_js_block %}
<script type="text/javascript">
    $(document).ready(function(){
        $('input[type="file"].file_upload_input').change(function(e){
            var fileName = e.target.files[0].name;
            if (fileName !='') {
                $('.file_name_placeholder').show(200).text(fileName);
                $(".file_name_placeholder").css("opacity", "1");
            } else {
                $('.file_name_placeholder').hide();
            }
        });

        $('form').submit(function(e){
            var filename = $('input[type="file"].file_upload_input').val().split('\\').pop();
            if (filename != ''){
                $("input[type='submit']").attr("disable","disable");
                $("#cancelLink").removeAttr("href");
                $("input[type='submit']").parent().addClass('less-visibile');
                toastr.info('Please wait..The file is getting uploaded', 'Information',{timeOut: 0, extendedTimeOut: 0, tapToDismiss: false});
            }
        });

    });
</script>
<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
<script>
    //This is All Just For Logging:
    var debug = true;//true: add debug logs when cloning
    var evenMoreListeners = true;//demonstrat re-attaching javascript Event Listeners (Inline Event Listeners don't need to be re-attached)
    if (evenMoreListeners) {
        var allFleChoosers = $("input[type='file']");
        addEventListenersTo(allFleChoosers);
        function addEventListenersTo(fileChooser) {
            fileChooser.change(function (event) { console.log("file( #" + event.target.id + " ) : " + event.target.value.split("\\").pop()) });
            fileChooser.click(function (event) { console.log("open( #" + event.target.id + " )") });
        }
    }

    var clone = {};

    // FileClicked()
    function fileClicked(event) {
        var fileElement = event.target;
        if (fileElement.value != "") {
            if (debug) { console.log("Clone( #" + fileElement.id + " ) : " + fileElement.value.split("\\").pop()) }
            clone[fileElement.id] = $(fileElement).clone(); //'Saving Clone'
        }
        //What ever else you want to do when File Chooser Clicked
    }

    // FileChanged()
    function fileChanged(event) {
        var fileElement = event.target;
        if (fileElement.value == "") {
            if (debug) { console.log("Restore( #" + fileElement.id + " ) : " + clone[fileElement.id].val().split("\\").pop()) }
            clone[fileElement.id].insertBefore(fileElement); //'Restoring Clone'
            $(fileElement).remove(); //'Removing Original'
            if (evenMoreListeners) { addEventListenersTo(clone[fileElement.id]) }//If Needed Re-attach additional Event Listeners
        }
        //What ever else you want to do when File Chooser Changed
    }
    </script>
{% endblock app_js_block %}
